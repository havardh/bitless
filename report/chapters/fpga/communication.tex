\FloatBarrier
\section{Communication}\label{section:fpga-buses}

\subsection{The External Bus Interface}
The microcontroller communicates with the FPGA design using the External Bus
Interface (EBI) of the Giant Gecko microcontroller. The EBI is a parallel bus
with a separate data and address bus in addition to the chip select and read and
write enable signals, all active low\cite{efm_ebi}.

The communication between the MCU and the FPGA uses 23 address lines and 16
data lines. All transfers are initiated by the chip select signal going low.
Then, for write transfers, the data and address lines are set up and the
write enable signal is asserted, see figure \ref{fig:ebi_write}. For reads,
the address is set up and the data line is put in high impedance mode before
the read enable signal is asserted, see figure \ref{fig:ebi_read}.

\input{figures/fpga/communication-ebi-write}
\input{figures/fpga/communication-ebi-read}

\FloatBarrier
\subsection{The Internal Bus}

The internal bus is used to transfer data to and from modules in the FPGA.
All transfers are initiated by the microcontroller on the EBI bus, and the
EBI controller module facilitates communication between the EBI and the
internal bus.

\subsubsection{The EBI controller}
The EBI controller module is used to handle EBI transfers initiated by the
microcontroller. It consists of a simple state machine, illustrated in
figure \ref{fig:ebi_ctrl_fsm}. When an EBI transfer is executed, the
internal bus, described in is used to store or retrieve data from a module
in the FPGA.

In the idle state, the EBI data lines are set as high impedance, which
causes the microcontroller to have control of the data bus. Only when
a value is read over the EBI bus, does the EBI controller take control of
the data lines.

\input{figures/fpga/communication-ebi-ctrl-fsm}

\FloatBarrier
\subsubsection{Addressing}

Modules in the FPGA is addressed using a simple addressing scheme, where the
address is divided into several parts, as illustrated in figure \ref{fig:ebi_addresses}.

\input{figures/fpga/communication-ebi-addresses}

A single bit, the T bit, is used to select the toplevel control register.
If the T bit is set, the rest of the address is ignored, and only the toplevel
control register is accessible.

If the T bit is not set, the pipeline field is used to select which pipeline
to address. In the pipeline, the device field is decoded and used to select
which pipeline module to address. Two device numbers have special meaning;
device 0 is the pipeline control register, while device 1 is the constant
memory. All device numbers starting at 2 accesses the cores in the pipeline.

The subdevice field is used to select between modules in each core. These
are listed in table \ref{tab:core_subdevices}.

\input{figures/fpga/communication-core-subdevices}

\FloatBarrier
\subsubsection{Read Transfers}

A read transfer is initiated when the read enable line from the microcontroller
goes low. The EBI controller sets up the internal address signals and asserts
the internal read enable signal. This causes the requested data to be available
in the next clock cycle. The EBI controller switches to read state, where it
remains until the chip select signal is deasserted.

\subsubsection{Write Transfers}

Write transfers are initiated the same way as read transfers. As the 
write-enable signal goes low, the destination address is latched into the 
internal address bus and the internal data lines are set to the value of the 
EBI data lines. The internal write enable signal is asserted and the EBI 
controller enters the write state. In the write state the internal write enable 
signal is reset, and when the EBI write enable signal is deasserted, idle mode 
is reentered.
